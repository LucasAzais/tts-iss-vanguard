local Exploration = {}
Exploration.__index = Exploration

local Constants = require('Constants')
local EventManager = require('EventManager')
local Ui = require('Ui')

Exploration.HIDE_STORAGE_BAGS = true

Exploration.PLANETOPEDIA = '10e2ca'
Exploration.EXPLORATION_ZONE = '9f8780'
Exploration.EXPLORATION_BAG = '19a0f8'

Exploration.BOOK_SNAP_POINTS = {
    [1]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={2.18151021003723,0.200000420212746,-1.31571614742279},tags={"POI"}},
        {position={-1.17777848243713,0.200000405311584,-1.28869795799255},tags={"POI"}},
        {position={-1.17190146446228,0.200000405311584,-0.0138545352965593},tags={"POI"}},
        {position={-1.1944739818573,0.200000405311584,1.28264021873474},tags={"POI"}},
        {position={1.25952446460724,0.200000405311584,1.27237963676453},tags={"POI"}},
        {position={1.25520694255829,0.200000405311584,-0.0169726926833391},tags={"POI"}},
        {position={3.10375475883484,0.200000420212746,-0.0219584237784147},tags={"POI"}},
        {position={3.11351537704468,0.200000420212746,1.26377260684967},tags={"POI"}},
    },
    [2]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-4.62,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={1.6511470079422,0.200000405311584,-1.3027937412262},tags={"POI"}},
        {position={-1.04006540775299,0.200000405311584,-1.29019725322723},tags={"POI"}},
        {position={-1.04695296287537,0.200000405311584,0.00547946337610483},tags={"POI"}},
        {position={-1.05695056915283,0.200000405311584,1.29884171485901},tags={"POI"}},
        {position={1.64503061771393,0.200000405311584,1.28809297084808},tags={"POI"}},
        {position={2.79794645309448,0.200000420212746,0.00635916367173195},tags={"POI"}},
    },
    [3]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-4.62,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={3.11591506004334,0.200000420212746,-1.29533219337463},tags={"POI"}},
        {position={3.10333824157715,0.200000420212746,-0.00550875859335065},tags={"POI"}},
        {position={1.24854648113251,0.200000405311584,-0.0183674190193415},tags={"POI"}},
        {position={1.25157308578491,0.200000405311584,1.28531360626221},tags={"POI"}},
        {position={-1.04863691329956,0.200000405311584,-0.020473649725318},tags={"POI"}},
        {position={-1.04811036586761,0.200000405311584,-1.2964905500412},tags={"POI"}},
    },
    [4]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-4.62,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={3.10333824157715,0.200000420212746,-0.00550875859335065},tags={"POI"}},
        {position={1.24854648113251,0.200000405311584,-0.0183674190193415},tags={"POI"}},
        {position={1.25157308578491,0.200000405311584,1.28531360626221},tags={"POI"}},
        {position={-1.21263289451599,0.200000405311584,1.30924642086029},tags={"POI"}},
        {position={-1.21985042095184,0.200000405311584,0.014905990101397},tags={"POI"}},
        {position={-1.20670032501221,0.200000405311584,-1.26980662345886},tags={"POI"}},
    },
    [5]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={1.59183371067047,0.200000405311584,-1.30149459838867},tags={"POI"}},
        {position={3.12015771865845,0.200000420212746,-0.012871453538537},tags={"POI"}},
        {position={3.13718748092651,0.200000420212746,1.27129340171814},tags={"POI"}},
        {position={1.25902128219604,0.200000405311584,1.26830530166626},tags={"POI"}},
        {position={-1.45060098171234,0.200000405311584,1.29138827323914},tags={"POI"}},
        {position={-1.03957617282867,0.200000405311584,0.00357452919706702},tags={"POI"}},
    },
    [6]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-4.5,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={1.25773775577545,0.200000405311584,-1.31294310092926},tags={"POI"}},
        {position={3.12015771865845,0.200000420212746,-0.012871453538537},tags={"POI"}},
        {position={3.13718748092651,0.200000420212746,1.27129340171814},tags={"POI"}},
        {position={1.25902128219604,0.200000405311584,1.26830530166626},tags={"POI"}},
        {position={-1.2590172290802,0.200000405311584,0.00664347223937511},tags={"POI"}},
    },
    [7]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-4.62,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={3.13326263427734,0.200000420212746,-1.30042278766632},tags={"POI"}},
        {position={3.12015771865845,0.200000420212746,-0.012871453538537},tags={"POI"}},
        {position={3.14974808692932,0.200000420212746,1.29404711723328},tags={"POI"}},
        {position={1.2650820016861,0.200000405311584,1.30443215370178},tags={"POI"}},
        {position={1.2647910118103,0.200000405311584,-0.00568049587309361},tags={"POI"}},
        {position={1.2500114440918,0.200000405311584,-1.28918814659119},tags={"POI"}},
        {position={-1.03080654144287,0.200000405311584,-1.28956604003906},tags={"POI"}},
        {position={-1.03866231441498,0.200000405311584,0.00303582823835313},tags={"POI"}},
        {position={-1.040900349617,0.200000405311584,1.30516421794891},tags={"POI"}},
    },
    [8]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={2.39184260368347,0.200000420212746,-1.29753637313843},tags={"POI"}},
        {position={1.36092746257782,0.200000405311584,-0.00307698361575603},tags={"POI"}},
        {position={2.39658856391907,0.200000420212746,1.28025209903717},tags={"POI"}},
        {position={-1.0328563451767,0.200000405311584,0.837872564792633},tags={"POI"}},
        {position={-1.03333711624146,0.200000405311584,-0.868459224700928},tags={"POI"}},
    },
    [9]={
        {position={-3.17460370063782,0.200000390410423,1.347771525383},tags={"GlobalCondition"}},
        {position={-3.17399740219116,0.200000390410423,-0.614452600479126},tags={"Mission"}},
        {position={-3.18327689170837,0.200000390410423,0.368981629610062},tags={"Mission"}},
        {position={-4.62,0.200000390410423,0.368981629610062},tags={"Mission"}},
        {position={-3.18405199050903,0.200000390410423,-1.46488010883331},tags={"Discovery"}},
        {position={1.24906539916992,0.200000405311584,-1.30713772773743},tags={"POI"}},
        {position={-1.0569281578064,0.200000405311584,-1.29620242118835},tags={"POI"}},
        {position={-1.04717719554901,0.200000405311584,0.0018387729069218},tags={"POI"}},
        {position={-1.05964732170105,0.200000405311584,1.29188108444214},tags={"POI"}},
        {position={1.26049363613129,0.200000405311584,1.27983093261719},tags={"POI"}},
        {position={3.10874533653259,0.200000420212746,1.28121960163116},tags={"POI"}},
        {position={2.17333793640137,0.200000420212746,-0.00954504404217005},tags={"POI"}},
    },
    [10]={
        {position={-3.18905878067017,0.200000390410423,0.564482450485229},tags={"GlobalCondition"}},
        {position={-3.18199491500854,0.200000390410423,-1.43572926521301},tags={"Discovery"}},
        {position={-4.62,0.200000390410423,-0.502995610237122},tags={"Mission"}},
        {position={-4.62,0.200000390410423,0.565001487731934},tags={"Mission"}},
        {position={1.25315070152283,0.200000405311584,-1.28450798988342},tags={"POI"}},
        {position={3.10804796218872,0.200000420212746,0.000643581559415907},tags={"POI"}},
        {position={1.27114272117615,0.200000405311584,-0.00220180302858353},tags={"POI"}},
        {position={3.10874533653259,0.200000420212746,1.28121960163116},tags={"POI"}},
        {position={1.26049363613129,0.200000405311584,1.27983093261719},tags={"POI"}},
        {position={-1.32188904285431,0.200000405311584,1.29231154918671},tags={"POI"}},
        {position={-1.29695534706116,0.200000405311584,-0.00173324253410101},tags={"POI"}},
        {position={-1.30816030502319,0.200000405311584,-1.28862452507019},tags={"POI"}},
    },
    [11]={
        {position={-3.20013999938965,0.200000390410423,0.670277237892151},tags={"GlobalCondition"}},
        {position={-3.19752669334412,0.200000390410423,-0.19901031255722},tags={"Discovery"}},
        {position={-4.5,0.200000390410423,-0.19901031255722},tags={"Discovery"}},
        {position={-4.62,0.200000390410423,0.670277237892151},tags={"Mission"}},
        {position={3.18947052955627,0.200000420212746,1.28177571296692},tags={"POI"}},
        {position={3.16825294494629,0.200000420212746,-0.0245679896324873},tags={"POI"}},
        {position={3.17332434654236,0.200000420212746,-1.31124806404114},tags={"POI"}},
        {position={1.04504597187042,0.200000405311584,-1.2971156835556},tags={"POI"}},
        {position={1.04628396034241,0.200000405311584,-0.0103610772639513},tags={"POI"}},
        {position={1.05417335033417,0.200000405311584,1.28980076313019},tags={"POI"}},
        {position={-1.07878684997559,0.200000405311584,1.2847284078598},tags={"POI"}},
        {position={-1.07090067863464,0.200000405311584,-0.00284975138492882},tags={"POI"}},
        {position={-1.06525921821594,0.200000405311584,-1.29237329959869},tags={"POI"}},
    },
    [12]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-4.62,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={3.14556503295898,0.200000420212746,-1.29884421825409},tags={"POI"}},
        {position={1.4595605134964,0.200000405311584,-1.06705403327942},tags={"POI"}},
        {position={3.14825558662415,0.200000420212746,-0.000196899243746884},tags={"POI"}},
        {position={1.45638477802277,0.200000405311584,0.0131285395473242},tags={"POI"}},
        {position={3.14859390258789,0.200000420212746,1.29516053199768},tags={"POI"}},
        {position={1.26836156845093,0.200000405311584,1.29251074790955},tags={"POI"}},
        {position={-1.2260103225708,0.200000405311584,1.29722583293915},tags={"POI"}},
        {position={-1.22745084762573,0.200000405311584,0.0155115257948637},tags={"POI"}},
        {position={-1.54268944263458,0.200000405311584,-1.28931248188019},tags={"POI"}},
    },
    [13]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-4.62,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={2.21832585334778,0.200000420212746,-1.29861402511597},tags={"POI"}},
        {position={3.14246773719788,0.200000420212746,-0.0126816844567657},tags={"POI"}},
        {position={1.25870227813721,0.200000405311584,-0.0119379246607423},tags={"POI"}},
        {position={2.21076965332031,0.200000420212746,1.28666925430298},tags={"POI"}},
        {position={-1.38254523277283,0.200000405311584,-0.00494131213054061},tags={"POI"}},
        {position={-1.40981388092041,0.200000405311584,1.28481996059418},tags={"POI"}},
    },
    [14]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={2.21832585334778,0.200000420212746,-1.29861402511597},tags={"POI"}},
        {position={2.2009220123291,0.200000420212746,-0.00648873765021563},tags={"POI"}},
        {position={3.12246513366699,0.200000420212746,1.29427433013916},tags={"POI"}},
        {position={1.26758468151093,0.200000405311584,1.28085803985596},tags={"POI"}},
        {position={-1.3336935043335,0.200000405311584,0.722675681114197},tags={"POI"}},
        {position={-1.33924353122711,0.200000405311584,-0.749665081501007},tags={"POI"}},
    },
    [15]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={1.26343810558319,0.200000405311584,-1.30247974395752},tags={"POI"}},
        {position={2.96590352058411,0.200000420212746,-0.00708870775997639},tags={"POI"}},
        {position={1.25594115257263,0.200000405311584,1.28994381427765},tags={"POI"}},
        {position={-1.03104138374329,0.200000405311584,1.00830554962158},tags={"POI"}},
        {position={-1.04245615005493,0.200000405311584,-0.146672591567039},tags={"POI"}},
        {position={-1.04736542701721,0.200000405311584,-1.30090081691742},tags={"POI"}},
    },
    [16]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-4.62,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={3.08758497238159,0.200000420212746,-0.983656644821167},tags={"POI"}},
        {position={1.23957479000092,0.200000405311584,0.221674963831902},tags={"POI"}},
        {position={-1.03185987472534,0.200000405311584,0.224858775734901},tags={"POI"}},
    },
    [17]={
        {position={-3.17872333526611,0.200000390410423,0.663069188594818},tags={"GlobalCondition"}},
        {position={-3.18539619445801,0.200000390410423,-0.154954880475998},tags={"Discovery"}},
        {position={-4.62,0.200000390410423,0.663069188594818},tags={"Mission"}},
        {position={-4.62,0.200000390410423,-0.312895178794861},tags={"Mission"}},
        {position={3.15446972846985,0.200000420212746,-1.28718996047974},tags={"POI"}},
        {position={3.13859534263611,0.200000420212746,0.00820855423808098},tags={"POI"}},
        {position={1.27142310142517,0.200000405311584,-0.0178238954395056},tags={"POI"}},
        {position={1.27157235145569,0.200000405311584,-1.29964959621429},tags={"POI"}},
        {position={-1.21120917797089,0.200000405311584,-1.31410360336304},tags={"POI"}},
        {position={-1.20676147937775,0.200000405311584,-0.0127168688923121},tags={"POI"}},
        {position={-1.20281362533569,0.200000405311584,1.26864743232727},tags={"POI"}},
        {position={2.18510031700134,0.200000420212746,1.29168152809143},tags={"POI"}},
    },
    [18]={
        {position={-3.19420433044434,0.200000390410423,1.32485008239746},tags={"GlobalCondition"}},
        {position={-3.19260835647583,0.200000390410423,0.356117874383926},tags={"GlobalCondition"}},
        {position={-3.19316244125366,0.200000390410423,-0.621838271617889},tags={"Mission"}},
        {position={-3.18944430351257,0.200000390410423,-1.45088708400726},tags={"Discovery"}},
        {position={1.27157235145569,0.200000405311584,-1.29964959621429},tags={"POI"}},
        {position={1.27142310142517,0.200000405311584,-0.0178238935768604},tags={"POI"}},
        {position={3.13126993179321,0.200000420212746,-0.0142892580479383},tags={"POI"}},
        {position={3.14274954795837,0.200000420212746,1.27382552623749},tags={"POI"}},
        {position={1.26028645038605,0.200000405311584,1.29088866710663},tags={"POI"}},
        {position={-1.46577274799347,0.200000405311584,1.29840970039368},tags={"POI"}},
        {position={-1.46487069129944,0.200000405311584,-0.00550668640062213},tags={"POI"}},
    },
    [19]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={3.11995053291321,0.200000420212746,-1.29387402534485},tags={"POI"}},
        {position={3.13126993179321,0.200000420212746,-0.0142892580479383},tags={"POI"}},
        {position={3.14274954795837,0.200000420212746,1.27382552623749},tags={"POI"}},
        {position={1.26028645038605,0.200000405311584,1.29088866710663},tags={"POI"}},
        {position={1.27142310142517,0.200000405311584,-0.0178238935768604},tags={"POI"}},
        {position={1.27157235145569,0.200000405311584,-1.29964959621429},tags={"POI"}},
        {position={-1.0387122631073,0.200000405311584,-1.29384422302246},tags={"POI"}},
        {position={-1.03666472434998,0.200000405311584,0.00470678089186549},tags={"POI"}},
        {position={-1.02588534355164,0.200000405311584,1.29172515869141},tags={"POI"}},
    },
    [20]={
        {position={-3.16940593719482,0.200000390410423,-0.541876137256622},tags={"Discovery"}},
        {position={-3.17356967926025,0.200000390410423,0.324112355709076},tags={"Mission"}},
        {position={-3.17726397514343,0.200000390410423,1.33612453937531},tags={"GlobalCondition"}},
        {position={3.0870509147644,0.200000420212746,-1.29873728752136},tags={"POI"}},
        {position={3.09807157516479,0.200000420212746,-0.0103854592889547},tags={"POI"}},
        {position={3.10805153846741,0.200000420212746,1.28154921531677},tags={"POI"}},
        {position={1.26028645038605,0.200000405311584,1.29088866710663},tags={"POI"}},
        {position={1.2534214258194,0.200000405311584,-0.00606776727363467},tags={"POI"}},
        {position={1.25412166118622,0.200000405311584,-1.29544472694397},tags={"POI"}},
        {position={-1.0387122631073,0.200000405311584,-1.29384422302246},tags={"POI"}},
        {position={-1.03666472434998,0.200000405311584,0.00470678089186549},tags={"POI"}},
        {position={-1.02588534355164,0.200000405311584,1.29172515869141},tags={"POI"}},
    },
}

------------------------------------------------------

function Exploration.init(savedData)
    Exploration.toggleBagsDisplay(not Exploration.HIDE_STORAGE_BAGS)
    Exploration.saved_positions = savedData.saved_positions or {}

    -- Set a new function for the book page change (overwritten on mod load, but it doesn't matter)
    local book = getObjectFromGUID(Exploration.PLANETOPEDIA)
    Global.setVar('onPlanetopediaPageChange', function(params)
        if not params.target then return end

        params.target.setSnapPoints({})
        if Exploration.BOOK_SNAP_POINTS[params.target.Book.getPage()] then
            params.target.setSnapPoints(Exploration.BOOK_SNAP_POINTS[params.target.Book.getPage()])
        end
    end)
    
    -- Then update the book's script (will just overwrite it if already present)
    -- Doesn't need to be added on start/end phase since it stays on the book.
    if book then
        book.setLuaScript("")
        book.setLuaScript("function onPageChange() Global.call('onPlanetopediaPageChange', {target = self}) end")
        book.reload()
    end
end

function Exploration.startPhase()
    local explorationBag = getObjectFromGUID(Exploration.EXPLORATION_BAG)

    for _, saved in ipairs(Exploration.saved_positions) do
        explorationBag.takeObject({
            position          = saved.position,
            rotation          = saved.rotation,
            callback_function = function(obj)
                obj.setLock(saved.lock)
            end,
            smooth            = false,
            guid              = saved.guid,
        })
    end
end

function Exploration.endPhase()
    local explorationBag = getObjectFromGUID(Exploration.EXPLORATION_BAG)

    -- Reset positions and register them again
    Exploration.saved_positions = {}
    for _, object in ipairs(getObjectFromGUID(Exploration.EXPLORATION_ZONE).getObjects()) do
        -- Save the GUID and position of all objects
        if object.getGUID() ~= Constants.TABLE_GUID then
            table.insert(Exploration.saved_positions, {
                guid = object.getGUID(),
                position = object.getPosition(),
                rotation = object.getRotation(),
                lock = object.getLock()
            })

            -- Put the object away
            object.attachInvisibleHider('hide', true)
            explorationBag.putObject(object)
        end
    end
end

function Exploration.toggleBagsDisplay(displayBags)
    getObjectFromGUID(Exploration.EXPLORATION_BAG).attachInvisibleHider('hide', not displayBags)
    getObjectFromGUID(Exploration.EXPLORATION_BAG).getComponent('AudioSource').set('mute', not displayBags)

    Exploration.HIDE_STORAGE_BAGS = not displayBags
end

function Exploration.save()
    local flatData = {
        saved_positions = Exploration.saved_positions
    }

    return flatData
end

------------------------------------------------------

return {
    PLANETOPEDIA = Exploration.PLANETOPEDIA,
    init = Exploration.init,
    save = Exploration.save,
    startPhase = Exploration.startPhase,
    endPhase = Exploration.endPhase,
    toggleBagsDisplay = Exploration.toggleBagsDisplay,
}